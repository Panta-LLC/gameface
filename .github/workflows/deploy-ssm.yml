name: Deploy to EC2 via SSM

on:
  workflow_dispatch:
    inputs:
      instance-id:
        description: 'EC2 Instance ID to deploy to'
        required: true
      aws-region:
        description: 'AWS region where the instance lives'
        required: false
        default: 'us-east-2'

permissions:
  contents: read

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/gameface
      IMAGE_TAG: ${{ github.sha }}
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: '.'
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Set image output
        id: set-image
        run: echo "image=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> "$GITHUB_OUTPUT"

  deploy-via-ssm:
    name: Deploy via SSM
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ github.event.inputs.aws-region }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN || '' }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID || '' }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY || '' }}

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Run deploy commands via SSM
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          INSTANCE_ID: ${{ github.event.inputs.instance-id }}
        run: |
          set -euo pipefail
          echo "Preparing commands for SSM to run on instance $INSTANCE_ID"

          PARAMS=$(printf '%s\n' \
            "docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN" \
            "docker pull $IMAGE" \
            "docker stop gameface || true" \
            "docker rm gameface || true" \
            "docker run -d --name gameface -p 80:80 --restart unless-stopped $IMAGE" \
          | jq -R -s -c 'split("\\n")[:-1]')

          echo "Sending SSM command to $INSTANCE_ID"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="$PARAMS" \
            --comment "Deploy from GitHub Actions" \
            --query 'Command.CommandId' --output text)

          echo "SSM Command ID: $COMMAND_ID"
          echo "Waiting for command to finish..."
          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID"

          echo "Retrieving command invocation result"
          aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --output json
